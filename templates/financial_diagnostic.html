{% extends 'base.html' %}

{% block title %}Diagnóstico Financeiro - {{ company.name }} - CFO as a Service{% endblock %}

{% block head_extra %}
<!-- Chart.js para gráficos -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    /* Estilos para o dashboard */
    .health-indicator {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 20px;
        color: white;
        font-size: 24px;
    }
    
    .health-indicator i {
        font-size: 40px;
    }
    
    .health-success {
        background-color: #28a745;
    }
    
    .health-warning {
        background-color: #ffc107;
        color: #212529;
    }
    
    .health-danger {
        background-color: #dc3545;
    }
    
    .overview-card {
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
        padding: 20px;
        background-color: #fff;
    }
    
    .kpi-value {
        font-size: 24px;
        font-weight: bold;
        margin-bottom: 5px;
    }
    
    .kpi-label {
        font-size: 14px;
        color: #6c757d;
    }
    
    .section-title {
        font-size: 20px;
        font-weight: bold;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 1px solid #e9ecef;
    }
    
    .info-card {
        background-color: #f8f9fa;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
    }
    
    .info-card-title {
        font-weight: bold;
        margin-bottom: 10px;
    }
    
    .risk-tag {
        display: inline-block;
        background-color: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 20px;
        padding: 5px 15px;
        margin-right: 5px;
        margin-bottom: 5px;
    }
    
    .chart-container {
        position: relative;
        height: 250px;
        margin-bottom: 20px;
    }
    
    .tam-sam-som-bar {
        height: 30px;
        background-color: #e9ecef;
        border-radius: 15px;
        margin-bottom: 10px;
        overflow: hidden;
    }
    
    .tam-bar {
        height: 100%;
        background-color: #007bff;
        border-radius: 15px;
    }
    
    .sam-bar {
        height: 100%;
        background-color: #007bff;
        border-radius: 15px;
    }
    
    .som-bar {
        height: 100%;
        background-color: #007bff;
        border-radius: 15px;
    }
    
    .operational-stats {
        display: flex;
        justify-content: space-between;
        margin-bottom: 20px;
    }
    
    .stat-box {
        text-align: center;
        padding: 15px;
        background-color: #f8f9fa;
        border-radius: 8px;
        flex: 1;
        margin: 0 10px;
    }
    
    .stat-value {
        font-size: 24px;
        font-weight: bold;
    }
    
    .stat-label {
        font-size: 14px;
        color: #6c757d;
    }
</style>
{% endblock %}

{% block content %}
<h1 class="mt-4">Diagnóstico Financeiro - {{ company.name }}</h1>

{% if diagnostic %}
    <!-- Dashboard de Saúde Financeira -->
    <div class="row mt-4">
        <!-- Visão Geral -->
        <div class="col-12 overview-card">
            <div class="section-title">Visão Geral</div>
            <div class="d-flex align-items-center">
                <!-- Indicador de Saúde Financeira -->
                <div class="health-indicator health-{{ diagnostic.dashboard.health_color }}">
                    <i class="fas fa-check"></i>
                </div>
                <div>
                    <h2>{{ diagnostic.dashboard.health_status }}</h2>
                    <div class="row mt-3">
                        <div class="col-md-6 col-lg-3 mb-3">
                            <div class="kpi-label">Faturamento anual (R$)</div>
                            <div class="kpi-value">{{ diagnostic.dashboard.kpis.faturamento_anual_formatado }}</div>
                        </div>
                        <div class="col-md-6 col-lg-3 mb-3">
                            <div class="kpi-label">Crescimento projetado</div>
                            <div class="kpi-value">{{ diagnostic.dashboard.kpis.crescimento_projetado }}%</div>
                        </div>
                        <div class="col-md-6 col-lg-3 mb-3">
                            <div class="kpi-label">Margem operacional estimada</div>
                            <div class="kpi-value">{{ diagnostic.dashboard.kpis.margem_operacional }}%</div>
                        </div>
                        <div class="col-md-6 col-lg-3 mb-3">
                            <div class="kpi-label">Estrutura de custos (%)</div>
                            <div class="kpi-value">{{ diagnostic.dashboard.kpis.estrutura_custos }}%</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-4">
        <!-- Financeiro -->
        <div class="col-md-7 mb-4">
            <div class="overview-card h-100">
                <div class="section-title">Financeiro</div>
                <div class="row">
                    <div class="col-md-7">
                        <h5>Evolução de Receita vs Custos</h5>
                        <div class="chart-container">
                            <canvas id="revenueVsCostsChart"></canvas>
                        </div>
                    </div>
                    <div class="col-md-5">
                        <h5>Distribuição dos custos</h5>
                        <div class="chart-container">
                            <canvas id="costDistributionChart"></canvas>
                        </div>
                        <div class="d-flex justify-content-center mt-2">
                            <div class="me-3">
                                <i class="fas fa-square text-primary"></i> Fixos
                            </div>
                            <div>
                                <i class="fas fa-square text-secondary"></i> Variáveis
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modelo de Negócio -->
        <div class="col-md-5 mb-4">
            <div class="overview-card h-100">
                <div class="section-title">Modelo de negócio</div>
                <div class="info-card">
                    <div class="info-card-title">{{ diagnostic.dashboard.business_info.modelo_negocios }}</div>
                </div>
                
                <div class="section-title mt-4">Principais fontes de receita</div>
                <div class="info-card">
                    <div>{{ diagnostic.dashboard.business_info.principais_produtos }}</div>
                </div>
                
                <div class="section-title mt-4">Principais riscos</div>
                <div class="risk-tag">{{ diagnostic.dashboard.business_info.principais_riscos }}</div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Mercado -->
        <div class="col-md-7 mb-4">
            <div class="overview-card h-100">
                <div class="section-title">Mercado</div>
                <h5>TAM/SAM/SOM</h5>
                
                <div class="mt-4">
                    <div>TAM (Mercado Total)</div>
                    <div class="tam-sam-som-bar">
                        <div class="tam-bar" style="width: 100%"></div>
                    </div>
                    <div class="text-end">{{ diagnostic.dashboard.market_data.tam_valor }}</div>
                </div>
                
                <div class="mt-3">
                    <div>SAM (Mercado Disponível)</div>
                    <div class="tam-sam-som-bar">
                        <div class="sam-bar" style="width: {{ diagnostic.dashboard.market_data.sam_pct }}%"></div>
                    </div>
                    <div class="text-end">{{ diagnostic.dashboard.market_data.sam_valor }}</div>
                </div>
                
                <div class="mt-3">
                    <div>SOM (Mercado Obtido)</div>
                    <div class="tam-sam-som-bar">
                        <div class="som-bar" style="width: {{ diagnostic.dashboard.market_data.som_pct }}%"></div>
                    </div>
                    <div class="text-end">{{ diagnostic.dashboard.market_data.som_valor }}</div>
                </div>
                
                <div class="mt-4">
                    <div class="chart-container">
                        <canvas id="operationalChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Operacional -->
        <div class="col-md-5 mb-4">
            <div class="overview-card h-100">
                <div class="section-title">Operacional</div>
                
                <div class="operational-stats">
                    <div class="stat-box">
                        <div class="stat-value">{{ diagnostic.dashboard.business_info.num_funcionarios }}</div>
                        <div class="stat-label">Funcionários</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value">{{ diagnostic.dashboard.kpis.produtividade_media_formatada }}</div>
                        <div class="stat-label">Produtividade média</div>
                    </div>
                </div>
                
                <div class="section-title mt-4">Principais riscos</div>
                <div class="risk-tag">{{ diagnostic.dashboard.business_info.principais_riscos }}</div>
            </div>
        </div>
    </div>

    <!-- Recomendações -->
    <div class="card mt-4">
        <div class="card-header">Recomendações</div>
        <div class="card-body">
            <ul>
                {% for recommendation in diagnostic.recommendations %}
                <li>{{ recommendation }}</li>
                {% endfor %}
            </ul>
        </div>
    </div>

{% else %}
    <div class="alert alert-warning mt-4">
        O diagnóstico financeiro ainda não está disponível. Certifique-se de que o questionário foi preenchido e/ou documentos relevantes foram enviados e processados.
    </div>
{% endif %}

<div class="mt-4 mb-5">
    <a href="{{ url_for('company_detail', company_id=company.id) }}" class="btn btn-secondary"><i class="fas fa-arrow-left me-2"></i>Voltar para Detalhes da Empresa</a>
</div>

{% endblock %}

{% block scripts_extra %}
{% if diagnostic %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Gráfico de Evolução de Receita vs Custos
    const ctxRevenueCosts = document.getElementById('revenueVsCostsChart')?.getContext('2d');
    if (ctxRevenueCosts) {
        const chartData = {{ diagnostic.dashboard.chart_data|tojson }};
        
        new Chart(ctxRevenueCosts, {
            type: 'bar',
            data: {
                labels: chartData.anos,
                datasets: [
                    {
                        label: 'Receita',
                        data: chartData.receitas,
                        backgroundColor: '#007bff',
                        order: 1
                    },
                    {
                        label: 'Custos',
                        data: chartData.custos,
                        backgroundColor: '#6c757d',
                        order: 2
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                if (value >= 1000000) {
                                    return 'R$ ' + (value / 1000000).toFixed(1) + 'M';
                                } else if (value >= 1000) {
                                    return 'R$ ' + (value / 1000).toFixed(1) + 'K';
                                } else {
                                    return 'R$ ' + value;
                                }
                            }
                        }
                    }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let value = context.raw;
                                if (value >= 1000000) {
                                    return context.dataset.label + ': R$ ' + (value / 1000000).toFixed(2) + ' milhões';
                                } else if (value >= 1000) {
                                    return context.dataset.label + ': R$ ' + (value / 1000).toFixed(2) + ' mil';
                                } else {
                                    return context.dataset.label + ': R$ ' + value;
                                }
                            }
                        }
                    }
                }
            }
        });
    }

    // Gráfico de Distribuição de Custos
    const ctxCostDistribution = document.getElementById('costDistributionChart')?.getContext('2d');
    if (ctxCostDistribution) {
        const costData = {{ diagnostic.dashboard.cost_structure|tojson }};
        
        new Chart(ctxCostDistribution, {
            type: 'pie',
            data: {
                labels: ['Fixos', 'Variáveis'],
                datasets: [{
                    data: [costData.fixos_pct, costData.variaveis_pct],
                    backgroundColor: [
                        '#007bff',
                        '#adb5bd'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.label + ': ' + context.raw + '%';
                            }
                        }
                    }
                }
            }
        });
    }

    // Gráfico Operacional
    const ctxOperational = document.getElementById('operationalChart')?.getContext('2d');
    if (ctxOperational) {
        new Chart(ctxOperational, {
            type: 'pie',
            data: {
                labels: ['Custos', 'Outros'],
                datasets: [{
                    data: [40, 60],
                    backgroundColor: [
                        '#007bff',
                        '#adb5bd'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.label + ': ' + context.raw + '%';
                            }
                        }
                    }
                }
            }
        });
    }
});
</script>
{% endif %}
{% endblock %}
